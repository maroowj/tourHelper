<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}"
      xmlns:th="http://www.thymeleaf.org">

<style layout:fragment="css">

</style>

<div layout:fragment="content">

    <main role="main" class="main-content">
        <script>
            const main_menu = 3;
        </script>

        <!--컨텐츠 영역-->
        <div class="contents">
            <div class="admin-contents-title">
                <h3 class="admin-title">여행지 예약관리</h3>
                <!--<div class="top-btn">
                    <a href="/admin/first-course/insert" class="blue-btn company-add-btn">예약 추가</a>
                    <a class="s-blue-btn company-update-btn cupoint">선택한 예약 수정</a>
                    <a href="#" class="gray-btn company-add-btn cupoint" id="courseCopy">예약 복사</a>
                    <a class="gray-btn company-delete-btn cupoint">선택한 예약 삭제</a>
                </div>-->
            </div><!--admin-contents-title-->

            <!--페이지 준비중-->
            <div class="no-content" style="display: none">
                <img src="/tourhelperUser/images/preparation.svg" onerror="this.style.background='var(--light-grey2)';"/>
            </div>

            <div class="company-wrap" style="">
                <div id="company-list-wrap" class="company-list-wrap">
                    <div class="search-wrap">
                        <input type="text" placeholder="신청자 검색" id="keyword" class="keyword">
                        <i id="search-icon" class="fa-solid fa-magnifying-glass search-icon"></i>
                    </div>

                    <ul class="companyList-wrap">
                        <li class='on' country=""><a class='cupoint'><span class='company-name'>전체</span></a></li>
                        <li class='' country="비즈니스"><a class='cupoint'><span class='company-name'>비즈니스</span></a></li>
                        <li class='' country="미얀마"><a class='cupoint'><span class='company-name'>미얀마 여행</span></a></li>
                        <li class='' country="대한민국"><a class='cupoint'><span class='company-name'>국내 여행</span></a></li>
                    </ul>
                </div>

                <div class="company-table">
                    <div class="admin-table-title-wrap">
                        <div class="admin-table-title">
                            <p class="title">전체</p>
                            <p class="detail-text">여행지 예약 리스트</p>
                        </div>

                        <div class="reserve-check-btn">
                            <!--<a href="/admin/first-course/insert" class="blue-btn company-add-btn">예약 추가</a>
                            <a class="s-blue-btn company-update-btn cupoint">선택한 예약 수정</a>
                            <a href="#" class="gray-btn company-add-btn cupoint" id="courseCopy">예약 복사</a>
                            <a class="gray-btn company-delete-btn cupoint">선택한 예약 삭제</a>-->
                        </div>
                    </div>

                    <!--table START-->
                    <table class="admin-table">
                        <colgroup>
                            <col style="width:8%">
                            <col style="width:15%">
                            <col style="width:10%">
                            <col style="width:20%">
                            <col style="">
                            <col style="">
                            <col style="width:10%">
                        </colgroup>
                        <thead>
                        <tr>
                            <!--<th class="after-none"><input type="checkbox" class="all-check"></th>-->
                            <th>번호</th>
                            <th>이름</th>
                            <th>연락처</th>
                            <th>이메일</th>
                            <th>여행지명</th>
                            <th>종류</th>
                            <th>참석여부</th>
                        </tr>
                        </thead>
                        <tbody id="tourList">
                        <tr>
                            <!--<td><input type='checkbox' class='checked'></td>-->
                          <!--  <td class="info">1</td>
                            <td class="info">김미영</td>
                            <td class="info">010-0000-0000</td>
                            <td class="info">kim@kakao.com</td>
                            <td class="info"><span class="content">2022년 12월 2일, 인원수: 3명</span></td>
                            <td class="info">-</td>
                            <td class="info"><span class="state-green">참석</span></td>-->
                        </tr>
                        <!--<tr>
                            <td><input type='checkbox' class='checked'></td>
                            <td class="info">김미영</td>
                            <td class="info">010-0000-0000</td>
                            <td class="info">kim@kakao.com</td>
                            <td class="info"><span class="content">2022년 12월 2일, 인원수: 3명</span></td>
                            <td class="info">-</td>
                            <td class="info"><span class="state-red">신청</span></td>
                        </tr>
                        <tr>
                            <td><input type='checkbox' class='checked'></td>
                            <td class="info">김미영</td>
                            <td class="info">010-0000-0000</td>
                            <td class="info">kim@kakao.com</td>
                            <td class="info"><span class="content">2022년 12월 2일, 인원수: 3명</span></td>
                            <td class="info">-</td>
                            <td class="info"><span class="state-grey">불참석</span></td>
                        </tr>-->
                        </tbody>
                    </table>

                    <div id="pagination"></div>
                </div><!--company-table-->

            </div><!--company-wrap-->

            <div id="companyColor" class="d-none">
                <span color="#ff8b8b" class="cp1">● #ff8b8b</span>
                <span color="#e54d4d" class="cp2">● #e54d4d</span>
                <span color="#fc9c47" class="cp3">● #fc9c47</span>
                <span color="#fdc631" class="cp4">● #fdc631</span>
                <span color="#9dcd80" class="cp5">● #9dcd80</span>
                <span color="#43b86c" class="cp6">● #43b86c</span>
                <span color="#22bfa0" class="cp7">● #22bfa0</span>
                <span color="#3bc2d6" class="cp8">● #3bc2d6</span>
                <span color="#228ecc" class="cp9">● #228ecc</span>
                <span color="#415ac2" class="cp10">● #415ac2</span>
                <span color="#9169ed" class="cp11">● #9169ed</span>
                <span color="#ab52cc" class="cp12">● #ab52cc</span>
                <span color="#e03da8" class="cp13">● #e03da8</span>
                <span color="#9c9c9c" class="cp14">● #9c9c9c</span>
            </div>

        </div><!--contents-->

        <!--예약신청 정보 MODAL START-->
        <div id="reservation-modal" class="modal admin-modal info-modal admin-info-modal" style="/*display: block*/">
            <div class="modal-wrap">
                <div class="modal-title-wrap">
                    <p class="title">예약신청 정보</p>
                    <i class="fa-solid fa-xmark close"></i>
                </div>
                <div class="modal-text-wrap">
                    <table class="date-table modal-table">
                        <colgroup>
                            <col style="width:140px">
                            <col style="width:calc(50% - 70px)">
                            <col style="width:140px">
                            <col style="width:calc(50% - 140px)">
                        </colgroup>
                        <tbody>
                        <tr>
                            <th>이름</th>
                            <td>
                                <div id="name" class="d-flex-wrap reservation-date"></div>
                            </td>
                            <th class="b-left">참석여부</th>
                            <td>
                                <div class="d-flex-wrap">
                                    <div class="select-box w80pro ma-l-10px">
                                        <select id="state" class="w100pro" style="width: 100%">
                                            <option value="신청">신청</option>
                                            <option value="참석">참석</option>
                                            <option value="불참석">불참석</option>
                                        </select>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>연락처</th>
                            <td>
                                <div id="tel" class="d-flex-wrap reservation-date"></div>
                            </td>
                            <th class="b-left">이메일</th>
                            <td>
                                <div id="email" class="d-flex-wrap"></div>
                            </td>
                        </tr>
                        <tr>
                            <th>여행지명</th>
                            <td>
                                <div id="title" class="d-flex-wrap reservation-date"></div>
                            </td>
                            <th class="b-left">종류(국가)</th>
                            <td>
                                <div id="country" class="d-flex-wrap"></div>
                            </td>
                        </tr>
                        <tr>
                            <th rowspan="3">내용</th>
                            <td rowspan="3" colspan="3">
                                <div id="content" class="d-flex-wrap reservation-date"></div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <!--일시 table END-->

                    <!--<table class="reserve-table modal-table">
                        <colgroup>
                            <col style="width:140px">
                            <col style="width:calc(20% - 70px)">
                            <col style="width:calc(30% - 70px)">
                            <col style="width:140px">
                            <col style="width:calc(50% - 140px)">
                        </colgroup>
                        <tbody>

                        <tr>
                            <th>신청기관명</th>
                            <td  colspan="2">
                                <div class="d-flex-wrap applicant">서울시립대학교</div>
                            </td>
                            <th class="b-left">방문대상</th>
                            <td colspan="2">
                                <div class="d-flex-wrap guest-type">대학생</div>
                            </td>
                        </tr>
                        <tr>
                            <th>방문대상 정보</th>
                            <td  colspan="5">
                                <div class="d-flex-wrap applicant-detail">
                                    일반
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>방문인원수</th>
                            <td  colspan="5">
                                <div class="d-flex-wrap quest-number">
                                    20명
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th class="program" rowspan="5">신청프로그램</th>
                            <td rowspan="2" class="table-blue-bg">1차 코스</td>
                            <td colspan="4">
                                <div class="d-flex-wrap first-course"></div>
                            </td>
                        </tr>
                        <tr id="secondInsert">
                            <td colspan="4">
                                <div class="d-flex-wrap">
                                    <ul class="program-detail">
                                        <li class="w100pro"><p class="title">소요시간</p><p class="text running-time">1시간 20분</p></li>
                                        <li class="w100pro"><p class="title">코<span class="gap">&nbsp;</span>스</p><p class="text course-detail">홍보관 - 침출수처리장 - 50MW발전시설 - 제 2·3매립장 - 통합계량대 - 양묘온실 - 야생화공원</p></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr class="secondOne sec" num="0">
                            <td rowspan="2" class="table-blue-bg">
                                2차 코스
                            </td>
                            <td colspan="4">
                                <div class="d-flex-wrap secondCourseTitle"></div>
                            </td>
                        </tr>
                        <tr class="secondTwo sec2" num="0">
                            <td colspan="4">
                                <div class="d-flex-wrap">
                                    <ul class="program-detail">
                                        <li><p class="title">소요시간</p><p class="text runningTime"></p></li>
                                        <li><p class="title">체험비용</p><p class="text cost"></p></li>
                                        <li class="w100pro"><p class="title">코<span class="gap">&nbsp;</span>스</p><p class="text course"></p></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5">
                                <div class="d-flex-wrap">
                                    <p class="all-time-title">전체 소요시간</p><p class="all-time-text"></p>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>담당자 연락처</th>
                            <td colspan="5">
                                <div class="d-flex-wrap manager-phone">
                                    010-1234-1234
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>차량종류 및 수</th>
                            <td colspan="5">
                                <div class="d-flex-wrap vehicle">
                                    승합차 1대
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>기타</th>
                            <td  colspan="5">
                                <div class="d-flex-wrap etc">
                                    기타내용
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="6">
                                <div class="ma-tb-10px">
                                    <p class="bold ma-b-4px">인솔자 비용 : <span class="f-right ma-l-4px">원</span><span class="f-right f-17 leaderCost">100,000</span></p>
                                    <p class="bold ma-b-4px">여행자 보험비용(방문자수*1,000원) : <span class="f-right ma-l-4px">원</span><span class="f-right f-17 travelCost">0</span></p>
                                    <p class="bold ma-b-4px">버스대절 비용(1대 기준/440,000원) : <span class="f-right ma-l-4px">원</span><span class="f-right f-17 busCost">0</span></p>
                                    <p class="bold ma-b-4px">2차코스 비용(1인) : <span class="f-right ma-l-4px">원</span><span class="f-right one f-17">0</span></p>
                                    <p class="bold ma-b-4px">2차코스 총 비용(방문자수*1인비용) : <span class="f-right ma-l-4px">원</span><span class="f-right tot f-17">0</span></p>
                                    <hr/>
                                    <p class="bold">총 합계 : <span class="f-right ma-l-4px">원</span><span class="f-right total f-17">0</span></p>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>-->
                    <!--신청내용 table END-->
                </div><!--modal-text-wrap-->
                <div class="modal-bottom">
                    <a class="modal-btn close-btn cupoint" style="margin-right:0;">닫기</a>
                    <a class="modal-btn reserve-btn ma-l-20px cupoint" onclick="updateState();">참석여부 수정</a>
                </div>
            </div><!--modal-wrap-->
            <div class="modal-bg-cover"></div>
        </div>

</main>

    <script>
        let page=1;
        let country;
        let tripSeq;
        $(function(){
            getReservationList();
        });

        // leftmenu 업체 클릭 시
        $("#company-list-wrap").on("click", ".companyList-wrap li", function(){
            $(".all-check, .checked").prop("checked", false);
            if( !$(this).hasClass("on") ) $(this).addClass("on");
            $(".companyList-wrap li").not(this).removeClass("on");

            country = $(this).attr("country");
            getReservationList(country);
        });

        $("#keyword").on("keydown", function(e) {
            if(e.keyCode==13) {
                $("#search-icon").click();
            }
        });

        $("#search-icon").on("click", function(){
            getReservationList(country);
        });

        $("#tourList").on("click", ".info", function() {
            tripSeq = $(this).parent().attr("seq");
            getReservationDetails(tripSeq);
            $("#reservation-modal").css("display", "block");
        });

        function getReservationDetails(tripSeq) {
            $.ajax({
                type:"get",
                url:"/api/admin/trip/" + tripSeq,
                success:function(data) {
                    // console.log(data);
                    $("#name").text(data.name);
                    $("#state").val(data.state);
                    $("#tel").text(data.tel);
                    $("#email").text(data.email);
                    $("#title").text(data.title);
                    $("#country").text(data.country)
                    $("#content").text(data.content);

                },
                error: function (request, status, error) {
                    toastModal("상세 정보를 불러오는데 실패했습니다.");
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }


        // 전체 업체코스리스트 불러오기
        function getReservationList(country){
            let keyword = $("#keyword").val();
            $.ajax({
                type: "GET",
                url: "/api/admin/trip",
                data: {
                    "page": page-1,
                    "size":10,
                    "keyword":keyword,
                    "country":country
                },
                success: function(data){
                    // console.log(data);
                    let rowNum = data.totalElements;

                    let tag = '';
                    if( data.content.length != 0 ) {
                        data.content.forEach(function (data, index) {
                            let stateTag = '';
                            if(data.state=='신청') {
                                stateTag = '<td class="info"><span class="state-red">신청</span></td>';
                            }else if(data.state=='참석') {
                                stateTag = '<td class="info"><span class="state-green">참석</span></td>';
                            }else if(data.state=='불참석') {
                                stateTag = '<td class="info"><span class="state-grey">불참석</span></td>';
                            }

                            tag += '<tr seq="'+data.tripSeq+'">' +
                                    '<td class="info">'+data.rowNum+'</td>' +
                                '<td class="info">'+data.name+'</td>' +
                                '<td class="info">'+data.tel+'</td>' +
                                '<td class="info">'+data.email+'</td>' +
                                '<td class="info"><span class="content">'+data.title+'</span></td>' +
                                '<td class="info">'+data.country+'</td>' +
                                stateTag +
                                '</tr>';
                        });
                        fPagination(data, page);
                    }else{
                        tag = '<tr><td colspan="7">여행지 예약 내역이 없습니다.</td></tr>';
                    }
                    $("#tourList").html(tag);
                }
            });
        }

        $("#pagination").on("click", "ul li a", function() {
            page = parseInt($(this).attr("gopage"));

            getReservationList(country);
        });

        function updateState() {
            $.ajax({
                type:"put",
                url:"/api/admin/trip/"+tripSeq,
                contentType:"application/json",
                data:JSON.stringify({
                    "state":$("#state").val()
                }),
                success:function() {
                    toastModal("참석여부가 수정되었습니다.");
                    setTimeout(() => $(".close-btn").click(), 1000);
                    getReservationList(country);
                },
                error: function (request, status, error) {
                    toastModal("참석 여부를 수정하는데 실패했습니다.");
                    console.log(request.status + ' ' + error.statusText + ' ' + request.responseText);
                }
            });
        }
    </script>

</div>
</html>